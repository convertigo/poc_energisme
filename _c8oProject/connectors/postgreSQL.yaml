jdbcDriverClassName: org.postgresql.Driver
jdbcURL: ${poc_energisme.database_url}
jdbcUserName: ${poc_energisme.database_user_name}
jdbcUserPassword: x48135d279776b75496c5b78e1e302274c353ff159ff159687ac79d415e987751e9b028a8a1f73f96182e3095469b863b
testOnBorrow: true
↓Default_transaction [transactions.SqlTransaction]: 
  ↑default: true
↓get_site [transactions.SqlTransaction]: 
  sqlQuery: |
    SELECT id, nom, com_cp, structure_insee, ST_X("position") as latitude, ST_Y("position") as longitude, country, typology, total_area_m2, year_of_construction
    FROM {{site_table}} s 
    WHERE s.id = CAST({site_id} AS BIGINT)
    AND s.typology is not null;
    
  ↓Test_Case [core.TestCase]: 
    ↓site_id [variables.TestCaseVariable-1672148194989]: 
      value: 14069
  ↓site_id [variables.RequestableVariable-1672148077216]: 
  ↓site_table [variables.RequestableVariable-1674048853473]: 
    value: ${poc_energisme.sites_table}
↓get_sites_list [transactions.SqlTransaction]: 
  sqlQuery: |
    'SELECT id, nom, com_cp, structure_insee, ST_X("position") as longitude, ST_Y("position") as latitude, country, typology, total_area_m2, year_of_construction
    FROM {{site_table}} s 
    WHERE s.typology is not null
    {{filter_condition}};'
  handlers: 
    →: |
      '// Handles the XML generated event.
      function onXmlGenerated() {
      	xpath = context.getXpathApi();
          root = dom.getDocumentElement();
      	els = xpath.selectNodeIterator(root, "//*[@type=''integer'' and .='''']");
      	while((el=els.nextNode()) != null){
      		el.setAttribute("type", "null");
      	}
      }'
  ↓Test_Case [core.TestCase]: 
    ↓filter_condition [variables.TestCaseVariable-1673962883661]: 
      description: filter_condition
      value: AND s.id IN (CAST('7632' AS BIGINT), CAST('7634' AS BIGINT), CAST('7635' AS BIGINT), CAST('7636' AS BIGINT), CAST('7637' AS BIGINT), CAST('7638' AS BIGINT), CAST('7731' AS BIGINT))
  ↓Test_Case_all_sites [core.TestCase]: 
    ↓filter_condition [variables.TestCaseVariable-1673885180239]: 
      description: filter_condition
  ↓Test_Case_sites_subset [core.TestCase]: 
    ↓filter_condition [variables.TestCaseVariable-1673885138036]: 
      description: filter_condition
      value: AND s.id IN (CAST('14122' AS BIGINT), CAST('13858' AS BIGINT))
  ↓filter_condition [variables.RequestableVariable-1673885109667]: 
    description: filter_condition
  ↓site_table [variables.RequestableVariable-1674049074082]: 
    value: ${poc_energisme.sites_table}
↓search_site [transactions.SqlTransaction]: 
  sqlQuery: |
    SELECT id, nom, com_cp, structure_insee, ST_X("position") as latitude, ST_Y("position") as longitude, country, typology, total_area_m2, year_of_construction
    FROM {{site_table}} s 
    WHERE LOWER(nom) LIKE '%{{label}}%'
    AND s.typology is not null;
  ↓Test_Case [core.TestCase]: 
    ↓label [variables.TestCaseVariable-1672757661610]: 
      description: label
      value: bar
  ↓label [variables.RequestableVariable-1672757643644]: 
    description: label
  ↓site_table [variables.RequestableVariable-1674049236006]: 
    description: site_table
↓select_UUID [transactions.SqlTransaction]: 
  sqlQuery: |
    SELECT uuid, avg(val) AS moy_val, label
    FROM {{raw_data_table}}
    GROUP BY uuid, label
  ↓raw_data_table [variables.RequestableVariable-1674049259761]: 
    description: raw_data_table
    value: ${poc_energisme.raw_data_table}
↓widget_conso [transactions.SqlTransaction]: 
  sqlQuery: |
    'select 
    sum (rd.val * sm.unit_coeff) filter (where sm."type"=''gaz'') as sum_conso_gaz,
    sum (rd.val * sm.unit_coeff) filter (where sm."type"=''elec'')  as sum_conso_elec,
    sum (rd.val * sm.unit_coeff) filter (where sm."type"=''weather'')  as sum_dju,
    {{agg_function}}  as agg_period
    from {{raw_data_table}} rd
    inner join {{sensor_mapping_table}} sm
    on rd.uuid = sm.sensor_id 
    where sm.site_id in ({{sites}})
    and rd.ts > TO_TIMESTAMP({date_start}, ''YYYY-MM-DD'')
    and rd.ts < TO_TIMESTAMP({date_end}, ''YYYY-MM-DD'')
    group by {{agg_function}}'
  handlers: 
    →: |
      '// Handles the XML generated event.
      function onXmlGenerated() {
      	xpath = context.getXpathApi();
          root = dom.getDocumentElement();
      	els = xpath.selectNodeIterator(root, "//*[@type=''double'' and .='''']");
      	while((el=els.nextNode()) != null){
      		el.setAttribute("type", "null");
      	}
      }'
  ↓Test_Case_Monosite_evolution_conso_agg_annee [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672928023866]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672928023869]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672928023872]: 
      value: CAST('7991' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672928023875]: 
      value: date_part('year', rd.ts)
  ↓Test_Case_Monosite_evolution_conso_agg_mois [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672928243853]: 
      description: date_start
      value: 2020-01-01
    ↓date_end [variables.TestCaseVariable-1672928243856]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672928243859]: 
      value: CAST('7626' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672928243862]: 
      value: date_part('year', rd.ts) || '_' || date_part('month', rd.ts) 
  ↓Test_Case_Monosite_evolution_conso_agg_semaine [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672928700573]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672928700576]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672928700579]: 
      value: CAST('7991' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672928700582]: 
      value: date_part('year', rd.ts) || '_' || date_part('week', rd.ts) 
  ↓Test_Case_Multisite_evolution_conso_agg_annee [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672927932946]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672927932949]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672927932952]: 
      value: CAST('7991' AS BIGINT), CAST('7626' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672927932955]: 
      value: date_part('year', rd.ts)
  ↓Test_Case_Multisite_evolution_conso_agg_jour [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1673943744634]: 
      description: date_start
      value: 2022-10-01
    ↓date_end [variables.TestCaseVariable-1673943744637]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1673943744640]: 
      value: CAST('7991' AS BIGINT), CAST('7626' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1673943744643]: 
      value: rd.ts::date
  ↓Test_Case_Multisite_evolution_conso_agg_mois [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672914161723]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672914161726]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672914161729]: 
      value: CAST('7991' AS BIGINT), CAST('7626' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672914161732]: 
      value: date_part('year', rd.ts) || '_' || date_part('month', rd.ts) 
  ↓Test_Case_Multisite_evolution_conso_agg_semaine [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672927548928]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672927548931]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672927548934]: 
      value: CAST('7991' AS BIGINT), CAST('7626' AS BIGINT)
    ↓agg_function [variables.TestCaseVariable-1672927548937]: 
      value: date_part('year', rd.ts) || '_' || date_part('week', rd.ts) 
  ↓date_start [variables.RequestableVariable-1672914161735]: 
    description: date_start
  ↓date_end [variables.RequestableVariable-1672914161738]: 
    description: date_end
  ↓sites [variables.RequestableVariable-1672914161741]: 
  ↓agg_function [variables.RequestableVariable-1672914161744]: 
  ↓raw_data_table [variables.RequestableVariable-1673534902509]: 
    value: ${poc_energisme.raw_data_table}
  ↓sensor_mapping_table [variables.RequestableVariable-1674049340461]: 
    description: sensor_mapping_table
    value: ${poc_energisme.sensor_mapping_table}
↓widget_conso_total [transactions.SqlTransaction]: 
  sqlQuery: |
    select
    sum (rd.val * sm.unit_coeff) filter (where sm."type"='gaz') as sum_conso_gaz,
    sum (rd.val * sm.unit_coeff) filter (where sm."type"='elec') as sum_conso_elec,
    sum (rd.val * sm.unit_coeff) filter (where sm."label"='weather') as sum_dju
    from {{raw_data_table}} rd
    inner join {{sensor_mapping_table}} sm
    on rd.uuid = sm.sensor_id
    where sm.site_id IN ({{sites}}) 
    and  rd.ts > TO_TIMESTAMP({date_start}, 'YYYY-MM-DD')
    and rd.ts < TO_TIMESTAMP({date_end}, 'YYYY-MM-DD')
  handlers: 
    →: |
      '// Handles the XML generated event.
      function onXmlGenerated() {
      	xpath = context.getXpathApi();
          root = dom.getDocumentElement();
      	els = xpath.selectNodeIterator(root, "//*[@type=''double'' and .='''']");
      	while((el=els.nextNode()) != null){
      		el.setAttribute("type", "null");
      	}
      }'
  ↓Test_Case_Multisite [core.TestCase]: 
    ↓date_start [variables.TestCaseVariable-1672914161749]: 
      description: date_start
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672914161752]: 
      description: date_end
      value: 2022-12-01
    ↓sites [variables.TestCaseVariable-1672914161755]: 
      value: CAST('7731' AS BIGINT)
  ↓date_start [variables.RequestableVariable-1672914161758]: 
    description: date_start
  ↓date_end [variables.RequestableVariable-1672914161761]: 
    description: date_end
  ↓sites [variables.RequestableVariable-1672914161764]: 
  ↓raw_data_table [variables.RequestableVariable-1673535861667]: 
    value: ${poc_energisme.raw_data_table}
  ↓sensor_mapping_table [variables.RequestableVariable-1674049606383]: 
    description: sensor_mapping_table
    value: ${poc_energisme.sensor_mapping_table}
↓widget_heatmap [transactions.SqlTransaction]: 
  sqlQuery: |
    select 
    sum (val * sm.unit_coeff) filter (where sm."type"={label}) as sum_label,
    date_part('week', ts) as week,
    date_part('hour', ts) as hour
    from {{raw_data_table}} rd
    inner join {{sensor_mapping_table}} sm
    on rd.uuid = sm.sensor_id 
    where sm.site_id IN ({{sites}}) 
    and rd.ts >= TO_TIMESTAMP({date_start}, 'YYYY-MM-DD')
    and rd.ts <= TO_TIMESTAMP({date_end}, 'YYYY-MM-DD')
    group by week , hour
    order by week asc, hour asc
  handlers: 
    →: |
      '// Handles the XML generated event.
      function onXmlGenerated() {
      	xpath = context.getXpathApi();
          root = dom.getDocumentElement();
      	els = xpath.selectNodeIterator(root, "//*[@type=''double'' and .='''']");
      	while((el=els.nextNode()) != null){
      		el.setAttribute("type", "null");
      	}
      }'
  ↓Test_Case [core.TestCase]: 
    ↓label [variables.TestCaseVariable-1672914161769]: 
      value: elec
    ↓date_start [variables.TestCaseVariable-1672914161772]: 
      value: 2021-01-01
    ↓date_end [variables.TestCaseVariable-1672914161775]: 
      value: 2022-12-31
    ↓sites [variables.TestCaseVariable-1672914161778]: 
      value: CAST('14122' AS BIGINT), CAST('7626' AS BIGINT)
    ↓raw_data_table [variables.TestCaseVariable-1674138912934]: 
      value: convertigo_poc.raw_data
    ↓sensor_mapping_table [variables.TestCaseVariable-1674138912936]: 
      description: sensor_mapping_table
      value: convertigo_poc.sensor_mapping
  ↓label [variables.RequestableVariable-1672914161781]: 
  ↓date_start [variables.RequestableVariable-1672914161784]: 
  ↓date_end [variables.RequestableVariable-1672914161787]: 
  ↓sites [variables.RequestableVariable-1672914161790]: 
  ↓raw_data_table [variables.RequestableVariable-1673535879411]: 
    value: ${poc_energisme.raw_data_table}
  ↓sensor_mapping_table [variables.RequestableVariable-1674049714301]: 
    description: sensor_mapping_table
    value: ${poc_energisme.sensor_mapping_table}
↓widget_multisite_sites_energivore [transactions.SqlTransaction]: 
  sqlQuery: |
    with conso_by_site as (
    	select avg (val * sm.unit_coeff) filter (where sm."type"='gaz') as avg_conso_gaz, 
    	avg (val * sm.unit_coeff) filter (where sm."type"='elec') as avg_conso_elec, site_id
    	from {{raw_data_table}} rd
    	inner join {{sensor_mapping_table}} sm
    	on rd.uuid = sm.sensor_id
    	and rd."label" = sm."label"
    	{{filter_condition}}
    	group by site_id)
    select conso_by_site.avg_conso_gaz, conso_by_site.avg_conso_elec, s.nom, ST_Y(s.position) as latitude, ST_X(s.position) as longitude, site_id
    from {{site_table}} s
    inner join conso_by_site 
    on conso_by_site.site_id = s.id
    order by avg_conso_gaz desc
    limit CAST({limit} AS BIGINT);
    
    
  handlers: 
    →: |
      '// Handles the XML generated event.
      function onXmlGenerated() {
      	xpath = context.getXpathApi();
          root = dom.getDocumentElement();
      	els = xpath.selectNodeIterator(root, "//*[@type=''double'' and .='''']");
      	while((el=els.nextNode()) != null){
      		el.setAttribute("type", "null");
      	}
      }'
  ↓Test_Case_all_sites [core.TestCase]: 
    ↓limit [variables.TestCaseVariable-1672914161795]: 
      description: limit
      value: 20
    ↓filter_condition [variables.TestCaseVariable-1673887820776]: 
      description: filter_condition
  ↓Test_Case_sites_subset [core.TestCase]: 
    ↓limit [variables.TestCaseVariable-1673888105771]: 
      description: limit
      value: 20
    ↓filter_condition [variables.TestCaseVariable-1673888105777]: 
      description: filter_condition
      value: AND sm.site_id IN (CAST('7626' AS BIGINT))
  ↓limit [variables.RequestableVariable-1672914161801]: 
    description: limit
  ↓raw_data_table [variables.RequestableVariable-1673535887851]: 
    value: ${poc_energisme.raw_data_table}
  ↓filter_condition [variables.RequestableVariable-1673887813493]: 
    description: filter_condition
  ↓sensor_mapping_table [variables.RequestableVariable-1674050025106]: 
    description: sensor_mapping_table
    value: ${poc_energisme.sensor_mapping_table}
  ↓site_table [variables.RequestableVariable-1674050025108]: 
    description: site_table
    value: ${poc_energisme.sites_table}